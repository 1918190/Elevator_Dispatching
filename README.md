# Elevator_Dispatching
os课设1——电梯调度

# 项目需求
## 基本任务
某一栋楼一共有20层，楼中有五部互联的电梯。基于线程思想，编写一个电梯调度程序。

## 功能需求
1.	电梯应有一些按键，如：数字键、关门键、开门键、上行键、下行键、报警键等。
2.	对于每一部电梯，都需要有数码显示器指示当前电梯状态。
3.	每层楼的每部电梯门口，都需要有上行、下行按钮、数码显示器。
4.	五部电梯相互联结，即当一个电梯按钮按下去时，其它电梯相应按钮同时点亮，表示也按下去了。也就是说，当一层楼中一部电梯门口的上行或者下行按钮被按下，五部电梯都会接收到指令。当一部电梯完成这个指令后，所有的电梯都不会被该指令影响。
5.	电梯调度算法：
 *	所有电梯初始状态都在第一层。
 *	每个电梯没有相应请求情况下，则应该在原地保持不动。
 *	电梯调度算法自行设计。

## 项目目的
1.	通过控制电梯调度，实现操作系统调度过程。
2.	学习特定环境下多线程编程方法。
3.	学习调度算法。

# 功能分析
基于项目目的与项目需求，我们对本项目进行功能分析。
首先，对于每一步电梯，都要有1-20每一层的按钮，用户只要按下其中一个按钮，用户目标楼层信息就会传达到电梯中，随后电梯会根据调度算法选择合适的路径。当电梯达到目标楼层时，电梯开门，用户离开电梯，同时电梯中该楼层的按钮从按下状态恢复到初始状态。对每一部电梯，设置默认开门时间为3秒钟。
对于每一部电梯，还会有另外四个按钮，这四个按钮分别代表不同的功能，功能如下：
1.	警报键。当按下警报键时，电梯无论在何种状态，都会停止运行，停留在当前位置。直到再次按下按钮后，电梯会恢复到按警报键前的最后状态，继续开始工作。
2.	呼叫键。当按下呼叫键时，如果电梯是在正常运行状态，则不会做出任何响应，电梯保持正常运行；如果电梯是在停止运行状态，那么按下呼叫键就相当于模拟工人来维修，5秒钟后，电梯就会从停止运行状态变为停止运行前的最后状态，继续开始工作。
3.	开门键。电梯的默认开门时间为3秒钟，3秒钟后电梯就会关门。当电梯在开门状态时按下开门键，电梯的开门时间会被重置为3秒钟。例如：当一个电梯已经在一层楼开门2秒钟，正常情况下应在1秒钟后关门，此时如果按下开门键，那么时间会被重置回3秒钟，即在3秒钟后才会关门。如果电梯在非开门状态下按下开门键，则不会做出任何响应。
4.	关门键。电梯的默认开门时间为3秒钟，3秒钟后电梯就会关门。当电梯在开门状态时按下关门键，那么电梯就会立刻在下一秒关门。例如：当一个电梯已经在一层楼开门1秒钟，正常情况下应在2秒钟后关门，此时如果按下关门键，那么在1秒钟后就会关门。如果电梯在非开门状态下按下关门键，则不会做出任何响应。

除开电梯，在每一个楼层上，也会有两个按钮，分别为上行按钮与下行按钮。这两个按钮与五部电梯是相联的，也就是说，在一层楼里按下上行/下行按钮，五部电梯都会收到该请求，此时就需要调度算法来选择最佳（即时间，电力消耗等方面综合最小）电梯来完成请求。上行按钮被按下代表该层有人想要上楼；下行按钮被按下代表该层有人想要下楼。一旦有电梯已经满足了该要求，该按钮就会从按下状态恢复到初始状态。为满足实际需要与合理性，第1楼的下行按钮与第20楼的上行按钮无法被按下。
最后是我们通过何种方式保持电梯系统整体运行。
1.	对于整个系统，通过周期性调用更新函数来更新系统状态。在本系统中，1秒钟调用一次更新函数。
2.	对于用户输入，用户输入会导致状态变化。但为了电梯的运行效率，不能仅仅只靠先来后到的方法来执行请求，每一部电梯需要能够记住自己需要停靠的楼层，安排合理的路径来完成所有请求。

# 算法设计
## 内调度算法设计
对于内调度，本项目使用的是SCAN算法的改进版——LOOK算法。扫描算法（SCAN）是一种按照楼层顺序依次服务请求，它让电梯在最底层和最顶层之间连续往返运行，在运行过程中响应处在于电梯运行方向相同的各楼层上的请求。它进行寻找楼层的优化，效率比较高，但它是一个非实时算法。扫描算法较好地解决了电梯移动的问题，在这个算法中，每个电梯响应乘客请求使乘客获得服务的次序是由其发出请求的乘客的位置与当前电梯位置之间的距离来决定的，所有的与电梯运行方向相同的乘客的请求在一次电向上运行或向下运行的过程中完成，免去了电梯频繁的来回移动。

对于LOOK算法，电梯依然在最顶层与最底层之间移动，但当LOOK算法发现电梯所移动的方向上不再有请求时立即改变运行方向，而扫描算法则需要移动到最底层或者最顶层时才改变运行方向。因此LOOK算法的效率会更高。

在本项目中，设置了maxFloor[5]与minFloor[5]两个数组，对应五部电梯。maxFloor代表此时电梯请求的最高层，minFloor代表此时电梯请求的最底层。上行状态时只用维护maxFloor，下行状态只用维护minFloor。

上行维护的方法为每次接受到一个新的请求，就判断新请求所在楼层与maxFloor的关系，如果更大，就更新maxFloor。如果上行状态时达到maxFloor，就改变状态为下行，随后从最底层往上遍历，第一个有请求的楼层即为minFloor，如果一直到电梯当前楼层还没有有请求的楼层，那么就把minFloor设为当前楼层。但如果转换状态后发现下行状态的minFloor找不到请求，那就把电梯状态设为空闲。

下行维护的方法为每次接受到一个新的请求，就判断新请求所在楼层与minFloor的关系，如果更小，就更新minFloor。如果下行状态时达到minFloor，就改变状态为上行。随后从最高层往下遍历，第一个有请求的楼层即为maxFloor，如果一直到电梯当前楼层还没有有请求的楼层，那么就把maxFloor设为当前楼层。但如果转换状态后发现上行状态的maxFloor找不到请求，那就把电梯状态设为空闲。

对于空闲状态的电梯，只需要判断新请求所在楼层与电梯当前楼层的大小关系，改变状态后，进行相应状态的处理即可。

## 外调度算法设计
对于外调度算法，本项目采用“1+3”的模式，即在主体算法的基础上设立三个可选扩展，这样在实际应用中也会更加灵活。
在收到请求后，算法将根据每个电梯到该请求的距离来衡量，选出具有最小距离的最优电梯来响应该请求。但其中的距离并不是简单的楼层相加，而是有方向的距离。一般分为以下几种情况。
1.	电梯顺路或者电梯处于空闲状态
此时计算距离最为简单，计算两者楼层数之差的绝对值即可。
距离=|请求所在楼层-当前楼层|
2.	电梯向上不顺路
此时即为电梯与请求均在上行方向，但请求所在层数比当前层数低，此时需要计算电梯上行到最高楼层再下行到最低楼层再上行到请求楼层的总距离。由于在电梯上行过程中有可能会因为之后的请求上升到20层，因此最高楼层使用20层而不是当前的maxFloor。下行同理使用最低楼层为1层。因此：
距离=（20-当前楼层）+（20-1）+（请求所在楼层-1）
3.	电梯向下不顺路
此时即为电梯与请求均在下行方向，但请求所在层数比当前层数高，此时需要计算电梯下行到最底楼层再上行到最高楼层再下行到请求楼层的总距离。
距离=（当前楼层-1）+（20-1）+（20-请求所在楼层）
4.	电梯向上，按钮向下
此时电梯上行，按钮请求向下，需要计算电梯上行到最高楼层再下行到请求楼层的总距离。
距离=（20-当前楼层）+（20-请求所在楼层）
5.	电梯向下，按钮向上
此时电梯下行，按钮请求向上，需要计算电梯下行到最底楼层再上行到请求楼层的总距离。
距离=（当前楼层-1）+（请求所在楼层-1）
除开上述的主体算法外，还有三个扩展，分别为计算开门时间，电梯维修时间过长更换服务电梯，关门时间过长惩罚。这三个扩展是为了让电梯调度系统的调配更加合理而实现的。关于这三个扩展的详细说明将在算法实现中体现。

### 计算开门时间（外调度可选）
每多路过一个请求，该电梯的dist则加上3。这样算出的dist会考虑电梯在路途中因为其他请求而停下的预计消耗时间。

### 电梯维修时间过长更换服务电梯（外调度可选）
此功能由calRepairTime这个Checkbox控制，只有它被用户选中后，该功能才被使用。在系统周期性函数会有一个用来计秒数的参数，一旦电梯工作状态变为停止后便开始计数，一旦秒数超过10秒便会跳转到changeElevator函数。在changeElevator函数中，系统遍历停止电梯的整个外请求队列，找到一个就会把该请求发送给除该电梯外的最优电梯执行。当发送完所有外请求后，就更新该停止电梯的最高/最低请求楼层。随后再用reachMinMax函数来判断去除所有外请求后的该电梯是否需要调转方向。

### 关门时间过长惩罚（外调度可选）
当某电梯在一层楼已经开门停靠了5秒钟后，每增加1秒钟等待时间，dist便加1，当电梯关门后，openTime会被清零。这样使得如果一个电梯在一个楼层被人一直占用后，之后的外请求不要在发送给该电梯，造成“饥饿”状态。


# 操作说明
1.	如果想要在某一楼层坐电梯，就点击该楼层的对应的上行/下行按钮，就会将该请求分配到最优电梯中
2.	如果在电梯里的人想到某一楼层，就点击对应电梯里该楼层，就会把该请求分配到该电梯中。
3.	如果电梯出现故障，就点击警报键，这时该电梯会立即停止工作。
4.	如果电梯在停止工作状态，那么点击呼叫键，电梯会用5秒钟时间维修，并在5秒后恢复正常。
5.	点击开门/关门键可以控制电梯门的状态，具体见功能分析。
6.	如果一部电梯处于停止工作状态，那么它的内部楼层按钮将无法点击。
7.	如果5部电梯都处于停止工作状态，那么外部上行/下行按钮将无法点击。
8.	已经在点击状态按钮无法被再次点击。
9.	当一个请求被满足后，界面上该按钮状态会恢复为初始状态。
10.	选择右下角的三个可选框可以给外调度算法加上对应的情况判断。

